
Licensed under the Apache License, Version 2.0 (the "License");

you may not use this file except in compliance with the License.

You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software

distributed under the License is distributed on an "AS IS" BASIS,

WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.

See the License for the specific language governing permissions and

limitations under the License.


----------------------------------------------------------

WARNING: This file is autogenerated. Do not manually edit.

----------------------------------------------------------


# GKE Demo 

### set project variables
#if not set, set project name with below command
#gcloud config set project "PROJECT_NAME"

export PROJECT_ID=$(gcloud info --format='value(config.project)')
export CLUSTER_NAME=onlineboutique
export ZONE=us-central1-b

### Enable GKE api
gcloud services enable container.googleapis.com --project ${PROJECT_ID}

### Enable monitoring apis
gcloud services enable monitoring.googleapis.com \
    cloudtrace.googleapis.com \
    clouddebugger.googleapis.com \
    cloudprofiler.googleapis.com \
    --project ${PROJECT_ID}

### Pull sample app
git clone https://github.com/GoogleCloudPlatform/microservices-demo.git
cd microservices-demo

### Create GKE Cluster
gcloud container clusters create ${CLUSTER_NAME} \
    --project=${PROJECT_ID} --zone=${ZONE} \
    --machine-type=e2-standard-2 --num-nodes=4

### Deploy the application
kubectl apply -f ./release/kubernetes-manifests.yaml

### Check the pod statuses (may check several times until all are running)
kubectl get pods

### Get the ingress IP
kubectl get service frontend-external | awk '{print $4}'



## Cleanup when done 
gcloud container clusters delete ${CLUSTER_NAME} \
    --project=${PROJECT_ID} --zone=${ZONE}


## If you have enabled Anthos and registered your cluster and would like to install ASM (istio), the following will do it.
### Verify ASM will install
sudo ./install_asm \
  --project_id ${PROJECT_ID} \
  --cluster_name ${CLUSTER_NAME} \
  --cluster_location ${ZONE} \
  --mode install \
  --output_dir tmp_output \
  --only_validate

### Install ASM
sudo ./install_asm \
  --project_id ${PROJECT_ID} \
  --cluster_name ${CLUSTER_NAME} \
  --cluster_location ${ZONE} \
  --mode install \
  --enable_all

### get cluster credentials 
 sudo gcloud container clusters get-credentials ${CLUSTER_NAME} \
    --project=${PROJECT_ID} --zone=${ZONE}

### get istio pod labels
kubectl -n istio-system get pods -l app=istiod --show-labels

### apply istio-injection.  rev value from label query above 
kubectl label namespace default  istio-injection- istio.io/rev=asm-183-2 --overwrite

### restart the deployment to apply the new settings
kubectl rollout restart deployment -n default

### verify it's all setup!
kubectl get pods -n default -l istio.io/rev=asm-183-2




